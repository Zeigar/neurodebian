#!/bin/bash

# Temporary scratch directory to save generated files.
TMP_DIR="tmp_$((1 + RANDOM % 10000))"

# Run common commands for each test at start of tests
#
# Parameters
# ----------
# distro : string
#   Valid values are "debain" or "ubuntu"
# release : string
#   Code name for distro release. (e.g. jessie)
# date : string
#   Date at which the snapshot of the OS is wanted
# keep_sources : string (Optional)
#   Pass the string "KEEP_SOURCES" to run nd_freeze with the --keep-original-apt-sources switch
#
function test_setup {
    distro=$1
    release=$2
    date=$3
    keep_sources=${4:-no}

    if [ "$keep_sources" = "no" ]; then
        keep_sources_param=""
    else
        keep_sources_param="--keep-original-apt-sources"
    fi

    mkdir -p $TMP_DIR

    docker run -it --rm -v $PWD/..:/home ${distro}:${release} /bin/bash -c "
        apt-get update
        apt-get install -y wget
        wget -O- http://neuro.debian.net/lists/${release}.us-nh.full | tee /etc/apt/sources.list.d/neurodebian.sources.list
        apt-key adv --recv-keys --keyserver hkp://pool.sks-keyservers.net:80 0xA5D32F012649A5A9
        apt-get update
        /home/nd_freeze $keep_sources_param $date
        if [ -f /etc/apt/sources.list ]; then
            cp /etc/apt/sources.list /home/tests/$TMP_DIR/sources.list
        fi
        if [ -f /etc/apt/sources.list.original ]; then
            cp /etc/apt/sources.list.original /home/tests/$TMP_DIR/sources.list.original
        fi
        if [ -f /etc/apt/sources.list.d/neurodebian.sources.list ]; then
            cp /etc/apt/sources.list.d/neurodebian.sources.list /home/tests/$TMP_DIR/neurodebian.sources.list
        fi
        if [ -f /etc/apt/sources.list.d/neurodebian.sources.list.original ]; then
            cp /etc/apt/sources.list.d/neurodebian.sources.list.original /home/tests/$TMP_DIR/neurodebian.sources.list.original
        fi
        if [ -f /etc/apt/sources.list.d/snapshots.sources.list ]; then
            cp /etc/apt/sources.list.d/snapshots.sources.list /home/tests/$TMP_DIR/snapshots.sources.list
        fi
    " > $TMP_DIR/stdout
}

# Run commands that are run at the end of each test run.
function test_teardown {
    rm -rf $TMP_DIR
}

# Test to see if a line is in a given file.
#
# Parameters
# ----------
# file : string
#   File to search for the given string
#
# line : string
#   Line the we expect to be in the file.
#
# match_mode : string
#   Enter "partial_match" if the line given is not a complete line but a line fragment
#
function assert_line_in_file {
    file=$1
    line=$2
    match_mode=${3:-full}

    if [ "$match_mode" = "full" ]; then
        match_param="x"
    else
        match_param=""
    fi

    if grep -Fq$match_param "$line" "$TMP_DIR/$file"; then
        echo "SUCCESS: line found"
    else
        echo "FAIL: File $file did not contain: $line"
        test_teardown
        exit 1
    fi
}

echo "Test basic operation ..."
test_setup "debian" "jessie" "7/27/2017"
assert_line_in_file "neurodebian.sources.list" "# deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list" "# deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list.original" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list.original" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20170727T050508Z/ jessie non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian/20170727T040550Z/ jessie-updates main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20170727T050508Z/ data non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian/20170727T040550Z/ jessie main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian-security/20170727T203455Z/ jessie/updates main"
assert_line_in_file "sources.list" "# deb http://deb.debian.org/debian jessie main"
assert_line_in_file "sources.list" "# deb http://deb.debian.org/debian jessie-updates main"
assert_line_in_file "sources.list" "# deb http://security.debian.org/debian-security jessie/updates main"
assert_line_in_file "sources.list.original" "deb http://deb.debian.org/debian jessie main"
assert_line_in_file "sources.list.original" "deb http://deb.debian.org/debian jessie-updates main"
assert_line_in_file "sources.list.original" "deb http://security.debian.org/debian-security jessie/updates main"
test_teardown

echo "Test handling of a different release ..."
test_setup "debian" "wheezy" "1/2/2018"
assert_line_in_file "neurodebian.sources.list" "# deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list" "# deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list.original" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list.original" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20180102T060503Z/ wheezy non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian/20180102T055258Z/ wheezy-updates main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20180102T060503Z/ data non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian/20180102T055258Z/ wheezy main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian-security/20180103T134828Z/ wheezy/updates main"
assert_line_in_file "sources.list" "# deb http://deb.debian.org/debian wheezy main"
assert_line_in_file "sources.list" "# deb http://deb.debian.org/debian wheezy-updates main"
assert_line_in_file "sources.list" "# deb http://security.debian.org/debian-security wheezy/updates main"
assert_line_in_file "sources.list.original" "deb http://deb.debian.org/debian wheezy main"
assert_line_in_file "sources.list.original" "deb http://deb.debian.org/debian wheezy-updates main"
assert_line_in_file "sources.list.original" "deb http://security.debian.org/debian-security wheezy/updates main"
test_teardown

echo "Test handling of request for a snapshot in the future ..."
test_setup "debian" "jessie" "20200827"
assert_line_in_file "neurodebian.sources.list" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "sources.list" "deb http://deb.debian.org/debian jessie main"
assert_line_in_file "sources.list" "deb http://deb.debian.org/debian jessie-updates main"
assert_line_in_file "sources.list" "deb http://security.debian.org/debian-security jessie/updates main"
assert_line_in_file "stdout" 'I: User provided time (20200827T000000Z) later than latest snapshot available' "partial_match"
test_teardown

echo "Test Ubuntu release ..."
test_setup "ubuntu" "xenial" "12/15/2017"
assert_line_in_file "neurodebian.sources.list" "# deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list" "# deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list.original" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list.original" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20171215T060503Z/ xenial non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20171215T060503Z/ data non-free main"
assert_line_in_file "sources.list" "deb http://archive.ubuntu.com/ubuntu/ xenial main restricted"
assert_line_in_file "sources.list" "deb http://archive.ubuntu.com/ubuntu/ xenial-updates main restricted"
assert_line_in_file "sources.list" "deb http://security.ubuntu.com/ubuntu/ xenial-security universe"
test_teardown

echo "Test --keep-original-apt-sources switch ..."
test_setup "debian" "jessie" "7/27/2017" "KEEP_SOURCES"
assert_line_in_file "neurodebian.sources.list" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "neurodebian.sources.list" "deb http://neuro.debian.net/debian data main contrib non-free"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20170727T050508Z/ jessie non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian/20170727T040550Z/ jessie-updates main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot-neuro.debian.net:5002/archive/neurodebian/20170727T050508Z/ data non-free contrib main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian/20170727T040550Z/ jessie main"
assert_line_in_file "snapshots.sources.list" "deb http://snapshot.debian.org/archive/debian-security/20170727T203455Z/ jessie/updates main"
assert_line_in_file "sources.list" "deb http://deb.debian.org/debian jessie main"
assert_line_in_file "sources.list" "deb http://deb.debian.org/debian jessie-updates main"
assert_line_in_file "sources.list" "deb http://security.debian.org/debian-security jessie/updates main"
test_teardown
